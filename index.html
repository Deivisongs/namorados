<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Express</title>
    
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* RESET E FONTES */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        :root {
            --primary-color: #4CAF50; /* Verde principal */
            --primary-dark: #388E3C;
            --text-dark: #333;
            --text-light: #757575;
            --bg-light: #f5f5f5;
            --white: #FFFFFF;
            --border-color: #EEEEEE;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            padding-bottom: 100px;
        }

        img {
            max-width: 100%;
            display: block;
        }

        button {
            cursor: pointer;
            border: none;
            background-color: transparent;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-text {
            font-size: 1.5rem; 
            font-weight: 700;
            color: var(--text-dark);
        }

        .cart-icon-container {
            position: relative;
            cursor: pointer;
        }

        .cart-icon-container i {
            width: 28px;
            height: 28px;
            color: var(--text-dark);
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--primary-color);
            color: var(--white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.75rem; 
            font-weight: 700;
        }

        /* CONTAINER PRINCIPAL */
        .container {
            padding: 16px;
        }

        .main-title {
            font-size: 2rem; 
            font-weight: 700;
            margin-bottom: 4px;
        }

        .main-subtitle {
            font-size: 1rem; 
            color: var(--text-light);
            margin-bottom: 24px;
        }

        /* CATEGORIAS E PRODUTOS (Sem alteração) */
        .category {
            margin-bottom: 24px;
        }

        .category-title {
            font-size: 1.25rem; 
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        .product-card {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
        }

        .product-info {
            flex: 1;
            min-width: 180px; 
            margin-right: 16px;
        }

        .product-title {
            font-size: 1.125rem; 
            font-weight: 700;
            margin-bottom: 4px;
        }

        .product-description {
            font-size: 0.875rem; 
            color: var(--text-light);
            margin-bottom: 12px;
        }

        .product-price {
            font-size: 1.125rem; 
            font-weight: 700;
            color: var(--text-dark);
        }

        .product-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }

        .add-to-cart-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.875rem; 
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            width: 100%; 
            justify-content: center;
        }

        .add-to-cart-btn:hover {
            background-color: var(--primary-dark);
        }

        @media (min-width: 400px) {
            .product-card {
                flex-wrap: nowrap;
            }
            .product-image {
                order: 1; 
            }
            .product-info {
                order: 0; 
            }
            .add-to-cart-btn {
                position: absolute;
                bottom: 16px;
                right: 16px;
                width: auto; 
                margin-top: 0;
            }
            .product-info {
                padding-right: 100px; 
            }
        }

        /* CARRINHO LATERAL */
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -100%; 
            width: 100%;
            max-width: 420px;
            height: 100vh;
            background-color: var(--white);
            box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
            z-index: 200;
            transition: right 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        .cart-sidebar.open {
            right: 0; 
        }

        .cart-header {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .cart-header i {
            width: 24px;
            height: 24px;
            color: var(--text-dark);
        }

        .cart-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-left: 12px;
            flex: 1;
        }

        .cart-close-btn {
            padding: 4px;
        }

        .cart-items-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .cart-empty-msg {
            text-align: center;
            color: var(--text-light);
            margin-top: 32px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        #cart-item-list > .cart-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .cart-item-img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 12px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .cart-item-price {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 8px;
        }
        
        .cart-item-obs-display {
            font-size: 0.875rem;
            color: var(--primary-dark);
            font-weight: 500;
            margin-bottom: 8px;
            word-break: break-word; 
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quantity-btn {
            background-color: var(--bg-light);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-weight: 700;
        }

        .quantity-btn i {
            width: 16px;
            height: 16px;
        }

        .quantity-btn.remove-btn {
            color: #E53935; 
        }

        .item-quantity {
            font-size: 1rem;
            font-weight: 500;
        }

        .cart-item-remove-btn {
            margin-left: 16px;
            color: var(--text-light);
        }

        /* Formulário */
        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-light);
        }

        .form-group input,
        .modal-textarea { 
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--bg-light);
        }

        .form-group input:focus,
        .modal-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--white);
        }
        
        /* Containers para campos lado a lado */
        .address-line-one,
        .address-line-two {
            display: flex;
            gap: 8px;
            margin-bottom: 12px; 
        }
        .address-line-one .form-group,
        .address-line-two .form-group {
            margin-bottom: 0; 
        }

        /* Distribuição de largura para Rua e Número */
        .address-line-one .rua-input {
            flex: 3; 
        }
        .address-line-one .numero-input {
            flex: 1; 
            max-width: 100px; 
        }

        /* Distribuição de largura para Bairro e Cidade */
        .address-line-two .bairro-input,
        .address-line-two .cidade-input {
            flex: 1; 
        }


        /* RODAPÉ DO CARRINHO */
        .cart-footer {
            padding: 16px;
            background-color: var(--white);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .cart-total span {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .finish-order-btn {
            width: 100%;
            padding: 16px;
            background-color: var(--primary-color);
            color: var(--white);
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            transition: background-color 0.2s;
        }

        .finish-order-btn:hover {
            background-color: var(--primary-dark);
        }

        .finish-order-btn:disabled {
            background-color: #BDBDBD;
            cursor: not-allowed;
        }

        /* OVERLAY DO CARRINHO */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 199;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        /* MODAL GERAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 299; 
            display: none; 
        }

        .product-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            z-index: 300; 
            padding: 24px;
            width: 90%;
            max-width: 400px; /* Padrão */
            display: none; 
            flex-direction: column;
            gap: 16px;
        }
        
        /* Modal de Endereço - Mais largo para acomodar os campos lado a lado */
        #addressDataModal {
             max-width: 480px; 
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
        }
        
        .modal-textarea {
            min-height: 80px;
            resize: vertical; 
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.2s;
        }
        
        .modal-btn.cancel {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }
        .modal-btn.cancel:hover {
            background-color: var(--border-color);
        }
        
        .modal-btn.confirm {
            background-color: var(--primary-color);
            color: var(--white);
        }
        .modal-btn.confirm:hover {
            background-color: var(--primary-dark);
        }
    </style>
</head>
<body>

    <header class="header">
        <span class="logo-text">Delivery Express</span>
        <div class="cart-icon-container" id="cartButton">
            <i data-feather="shopping-cart"></i>
            <span class="cart-count" id="cartCount">0</span>
        </div>
    </header>

    <main class="container">
        <h1 class="main-title">Cardápio</h1>
        <p class="main-subtitle">Escolha seus produtos favoritos e faça seu pedido</p>

        <section class="category">
            <h2 class="category-title">Lanches</h2>
            
            <article class="product-card" data-name="Hambúrguer Artesanal" data-price="28.90">
                <div class="product-info">
                    <h3 class="product-title">Hambúrguer Artesanal</h3>
                    <p class="product-description">Delicioso hambúrguer com queijo, alface, tomate e molho especial</p>
                    <span class="product-price">R$ 28.90</span>
                </div>
                <img src="https://i.imgur.com/qB0rS5s.png" alt="Hambúrguer Artesanal" class="product-image">
                <button class="add-to-cart-btn">
                    <i data-feather="plus"></i> Adicionar
                </button>
            </article>

        </section>

        <section class="category">
            <h2 class="category-title">Pizzas</h2>

            <article class="product-card" data-name="Pizza Margherita" data-price="45.00">
                <div class="product-info">
                    <h3 class="product-title">Pizza Margherita</h3>
                    <p class="product-description">Pizza tradicional com mussarela, tomate e manjericão fresco</p>
                    <span class="product-price">R$ 45.00</span>
                </div>
                <img src="https://i.imgur.com/UAUeNXC.png" alt="Pizza Margherita" class="product-image">
                <button class="add-to-cart-btn">
                    <i data-feather="plus"></i> Adicionar
                </button>
            </article>
        </section>

        <section class="category">
            <h2 class="category-title">Bebidas</h2>

            <article class="product-card" data-name="Suco de Laranja" data-price="8.50">
                <div class="product-info">
                    <h3 class="product-title">Suco de Laranja</h3>
                    <p class="product-description">Suco natural de laranja fresquinho, sem conservantes</p>
                    <span class="product-price">R$ 8.50</span>
                </div>
                <img src="https://i.imgur.com/MNDiWlY.png" alt="Suco de Laranja" class="product-image">
                <button class="add-to-cart-btn">
                    <i data-feather="plus"></i> Adicionar
                </button>
            </article>
        </section>

    </main>

    <aside class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <i data-feather="shopping-cart"></i>
            <h2 class="cart-title">Carrinho</h2>
            <button class="cart-close-btn" id="cartCloseBtn">
                <i data-feather="x"></i>
            </button>
        </div>

        <div class="cart-items-container" id="cartItemsContainer">
            
            <div id="cart-item-list">
                <p class="cart-empty-msg">Seu carrinho está vazio.</p>
            </div>
            
        </div>

        <div class="cart-footer">
            <div class="cart-total">
                <span>Total</span>
                <span id="cartTotal">R$ 0.00</span>
            </div>
            <button class="finish-order-btn" id="finishOrderBtn">
                Finalizar Pedido
            </button>
        </div>
    </aside>

    <div class="overlay" id="overlay"></div>
    
    <div class="modal-overlay" id="modalObsOverlay"></div>
    <div class="product-modal" id="productModal">
        <h3 class="modal-title" id="modalProductName">Nome do Produto</h3>
        <div class="form-group">
            <label for="modalObsTextarea">Tem alguma observação?</label>
            <textarea id="modalObsTextarea" class="modal-textarea" placeholder="Ex: Sem cebola, ponto da carne, etc."></textarea>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" id="modalCancelBtn">Cancelar</button>
            <button class="modal-btn confirm" id="modalConfirmBtn">Adicionar ao Carrinho</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="personalDataModalOverlay"></div>
    <div class="product-modal" id="personalDataModal">
        <h3 class="modal-title">1 de 2: Seus Dados Pessoais</h3>
        
        <form id="personalFormModal">
            <div class="form-group">
                <label for="nomeModal">Nome</label>
                <input type="text" id="nomeModal" name="nome" placeholder="Digite seu nome completo" required>
            </div>
            <div class="form-group">
                <label for="telefoneModal">Telefone</label>
                <input type="tel" id="telefoneModal" name="telefone" placeholder="(99) 99999-8888" maxlength="15" onkeyup="phoneMask(this)" required>
            </div>
            <div class="form-group">
                <label for="cpfModal">CPF (Opcional)</label>
                <input type="text" id="cpfModal" name="cpf" placeholder="000.000.000-00">
            </div>
        </form>

        <div class="modal-buttons">
            <button class="modal-btn cancel" id="personalDataCancelBtn">Voltar ao Carrinho</button>
            <button class="modal-btn confirm" id="personalDataConfirmBtn">Continuar para Endereço</button>
        </div>
    </div>

    <div class="modal-overlay" id="addressDataModalOverlay"></div>
    <div class="product-modal" id="addressDataModal">
        <h3 class="modal-title">2 de 2: Dados de Entrega</h3>
        
        <form id="addressFormModal">
            <div class="form-group">
                <label for="cepModal">CEP</label>
                <input type="text" id="cepModal" name="cep" placeholder="00000-000" maxlength="9" onkeyup="cepMask(this)" required>
            </div>
            
            <div class="address-line-one">
                <div class="form-group rua-input">
                    <label for="ruaModal">Rua</label>
                    <input type="text" id="ruaModal" name="rua" placeholder="Rua / Avenida" required>
                </div>
                <div class="form-group numero-input">
                    <label for="numeroModal">Nº</label>
                    <input type="text" id="numeroModal" name="numero" placeholder="123" required>
                </div>
            </div>
            
            <div class="address-line-two">
                <div class="form-group bairro-input">
                    <label for="bairroModal">Bairro</label>
                    <input type="text" id="bairroModal" name="bairro" placeholder="Bairro" required>
                </div>
                <div class="form-group cidade-input">
                    <label for="cidadeModal">Cidade</label>
                    <input type="text" id="cidadeModal" name="cidade" placeholder="Cidade" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="complementoModal">Complemento (Apto, Bloco, etc)</label>
                <input type="text" id="complementoModal" name="complemento" placeholder="Apto 101, Bloco A">
            </div>
            
        </form>

        <div class="modal-buttons">
            <button class="modal-btn cancel" id="addressDataBackBtn">Voltar para Dados Pessoais</button>
            <button class="modal-btn confirm" id="addressDataConfirmBtn">Enviar Pedido (WhatsApp)</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // SELETORES GLOBAIS
            const cartButton = document.getElementById('cartButton');
            const cartSidebar = document.getElementById('cartSidebar');
            const cartCloseBtn = document.getElementById('cartCloseBtn');
            const overlay = document.getElementById('overlay');
            const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
            const cartItemList = document.getElementById('cart-item-list'); 
            const cartCountEl = document.getElementById('cartCount');
            const cartTotalEl = document.getElementById('cartTotal');
            const finishOrderBtn = document.getElementById('finishOrderBtn');

            // SELETORES DO MODAL DE OBSERVAÇÃO
            const productModal = document.getElementById('productModal');
            const modalObsOverlay = document.getElementById('modalObsOverlay'); 
            const modalProductName = document.getElementById('modalProductName');
            const modalObsTextarea = document.getElementById('modalObsTextarea');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            
            // SELETORES DO MODAL 1 - DADOS PESSOAIS
            const personalDataModal = document.getElementById('personalDataModal');
            const personalDataModalOverlay = document.getElementById('personalDataModalOverlay');
            const personalFormModal = document.getElementById('personalFormModal');
            const personalDataConfirmBtn = document.getElementById('personalDataConfirmBtn');
            const personalDataCancelBtn = document.getElementById('personalDataCancelBtn');
            
            // SELETORES DO MODAL 2 - DADOS DE ENDEREÇO
            const addressDataModal = document.getElementById('addressDataModal');
            const addressDataModalOverlay = document.getElementById('addressDataModalOverlay');
            const addressFormModal = document.getElementById('addressFormModal');
            const addressDataConfirmBtn = document.getElementById('addressDataConfirmBtn');
            const addressDataBackBtn = document.getElementById('addressDataBackBtn');
            
            // CAMPOS DE ENDEREÇO
            const cepModal = document.getElementById('cepModal');
            const ruaModal = document.getElementById('ruaModal');
            const numeroModal = document.getElementById('numeroModal');
            const bairroModal = document.getElementById('bairroModal');
            const cidadeModal = document.getElementById('cidadeModal');
            const complementoModal = document.getElementById('complementoModal');
            
            // ESTADO: Armazena os dados do cliente
            let cart = [];
            let currentProductToAdd = null; 
            let customerData = {}; // Objeto para armazenar dados pessoais e de endereço

            // NÚMERO DE WHATSAPP (com código do país 55)
            const WHATSAPP_NUMBER = "5531991486490";


            // --- FUNÇÕES DE CONTROLE VISUAL ---

            function openCart() {
                cartSidebar.classList.add('open');
                overlay.classList.add('open');
            }

            function closeCart() {
                cartSidebar.classList.remove('open');
                overlay.classList.remove('open');
            }
            
            function openPersonalDataModal() {
                if (cart.length === 0) {
                    alert("Seu carrinho está vazio. Adicione itens antes de finalizar.");
                    return;
                }
                closeCart(); 
                personalDataModal.style.display = 'flex';
                personalDataModalOverlay.style.display = 'block';
            }
            
            function closePersonalDataModal() {
                personalDataModal.style.display = 'none';
                personalDataModalOverlay.style.display = 'none';
                openCart(); 
            }
            
            function openAddressDataModal() {
                // Fechar Modal 1 antes de abrir Modal 2
                personalDataModal.style.display = 'none';
                personalDataModalOverlay.style.display = 'none';
                
                addressDataModal.style.display = 'flex';
                addressDataModalOverlay.style.display = 'block';
            }
            
            function closeAddressDataModal() {
                addressDataModal.style.display = 'none';
                addressDataModalOverlay.style.display = 'none';
            }
            
            // --- FUNÇÃO PARA FECHAR O MODAL DE OBSERVAÇÃO ---
            const closeModalObs = () => {
                productModal.style.display = 'none';
                modalObsOverlay.style.display = 'none';
                currentProductToAdd = null;
            }
            
            // --- FUNÇÕES DE MÁSCARA ---
            
            window.cepMask = function(input) {
                let value = input.value.replace(/\D/g, ""); // Remove tudo que não é dígito
                value = value.replace(/^(\d{5})(\d)/, "$1-$2");
                input.value = value;
            }
            
            window.phoneMask = function(input) {
                let value = input.value.replace(/\D/g, "");
                value = value.replace(/^(\d{2})(\d)/g, "($1) $2"); 
                value = value.replace(/(\d)(\d{4})$/, "$1-$2"); 
                input.value = value;
            }


            // --- FUNÇÕES DE LÓGICA DE ENDEREÇO (VIACEP) ---

            async function fetchAddressByCep(cep) {
                const cleanCep = cep.replace(/\D/g, '');
                if (cleanCep.length !== 8) return; 

                // Bloqueia campos enquanto busca
                ruaModal.value = 'Buscando...';
                bairroModal.value = 'Buscando...';
                cidadeModal.value = 'Buscando...';
                ruaModal.disabled = true;
                bairroModal.disabled = true;
                cidadeModal.disabled = true;

                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);
                    const data = await response.json();

                    if (data.erro) {
                        alert("CEP não encontrado.");
                        // Limpa apenas os campos relacionados ao endereço
                        ruaModal.value = '';
                        bairroModal.value = '';
                        cidadeModal.value = '';
                        ruaModal.disabled = false;
                        bairroModal.disabled = false;
                        cidadeModal.disabled = false;
                        return;
                    }

                    ruaModal.value = data.logradouro || '';
                    bairroModal.value = data.bairro || '';
                    cidadeModal.value = data.localidade || ''; 
                    numeroModal.focus(); 
                } catch (error) {
                    console.error("Erro ao buscar CEP:", error);
                    alert("Erro ao conectar com o serviço de CEP.");
                } finally {
                    // Libera os campos para edição manual
                    ruaModal.disabled = false;
                    bairroModal.disabled = false;
                    cidadeModal.disabled = false;
                }
            }
            
            // --- FUNÇÃO DE ADICIONAR AO CARRINHO (CORRIGIDA) ---
            
            function confirmAddItemToCart() {
                if (!currentProductToAdd) return;

                const { name, price, image } = currentProductToAdd;
                const obs = modalObsTextarea.value.trim();

                const existingItem = cart.find(item => item.name === name && item.obs === obs);

                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cart.push({
                        name,
                        price,
                        image,
                        quantity: 1,
                        obs: obs 
                    });
                }

                updateCart();
                closeModalObs(); // AGORA FECHA O MODAL APÓS ADICIONAR
            }
            
            // --- FLUXO DE CHECKOUT EM DOIS PASSOS ---

            function handlePersonalDataSubmit() {
                // 1. Valida o formulário pessoal
                if (!personalFormModal.checkValidity()) {
                    personalFormModal.reportValidity();
                    return;
                }

                // 2. Armazena os dados pessoais
                const formData = new FormData(personalFormModal);
                customerData.nome = formData.get('nome');
                customerData.telefone = formData.get('telefone');
                customerData.cpf = formData.get('cpf');
                
                // 3. Abre o modal de endereço
                openAddressDataModal();
            }
            
            function handleAddressDataSubmit() {
                // 1. Valida o formulário de endereço
                if (!addressFormModal.checkValidity()) {
                    addressFormModal.reportValidity();
                    return;
                }
                
                // 2. Armazena os dados de endereço
                const formData = new FormData(addressFormModal);
                customerData.cep = formData.get('cep');
                customerData.rua = formData.get('rua');
                customerData.numero = formData.get('numero');
                customerData.bairro = formData.get('bairro');
                customerData.cidade = formData.get('cidade');
                customerData.complemento = formData.get('complemento');
                
                // 3. Envia o pedido completo
                sendOrderToWhatsapp();
            }
            
            // Função para voltar do Modal 2 para o Modal 1
            function handleBackToPersonalData() {
                closeAddressDataModal();
                openPersonalDataModal();
            }
            
            // --- FUNÇÃO PARA ENVIAR O PEDIDO VIA WHATSAPP ---
            
            function sendOrderToWhatsapp() {
                let message = "Olá, gostaria de fazer um novo pedido:\n\n";
                message += "*== ITENS DO PEDIDO ==*\n";
                
                cart.forEach(item => {
                    message += `*${item.quantity}x* - ${item.name}\n`;
                    message += `(Preço un.: R$ ${item.price.toFixed(2)})\n`;
                    if (item.obs) {
                        message += `  *Obs:* ${item.obs}\n`;
                    }
                    message += "-----------------\n";
                });

                message += `\n*TOTAL DO PEDIDO: ${cartTotalEl.textContent}*\n\n`;

                message += "*== DADOS DO CLIENTE ==*\n";
                message += `*Nome:* ${customerData.nome}\n`;
                message += `*Telefone:* ${customerData.telefone}\n`;
                if (customerData.cpf) { 
                    message += `*CPF:* ${customerData.cpf}\n`;
                }
                
                const enderecoCompleto = `${customerData.rua}, ${customerData.numero} - ${customerData.bairro}, ${customerData.cidade}`;
                message += `*Endereço:* ${enderecoCompleto}\n`;
                if (customerData.complemento) {
                    message += `*Complemento:* ${customerData.complemento}\n`;
                }
                message += `*CEP:* ${customerData.cep}\n`;

                const encodedMessage = encodeURIComponent(message);
                const whatsappURL = `https://api.whatsapp.com/send?phone=${WHATSAPP_NUMBER}&text=${encodedMessage}`;
                
                window.open(whatsappURL, '_blank');
                closeAddressDataModal(); 
            }

            // --- FUNÇÕES DE LÓGICA DO CARRINHO ---
            
            function updateCart() {
                renderCartItems();
                updateCartSummary();
            }
            
            function updateCartSummary() {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                cartCountEl.textContent = totalItems;
                cartTotalEl.textContent = `R$ ${totalPrice.toFixed(2)}`;
                finishOrderBtn.disabled = cart.length === 0;
            }
            
            function renderCartItems() {
                if (cart.length === 0) {
                    cartItemList.innerHTML = '<p class="cart-empty-msg">Seu carrinho está vazio.</p>';
                    return;
                }

                cartItemList.innerHTML = ''; 

                cart.forEach((item, index) => {
                    const cartItemHTML = `
                        <div class="cart-item">
                            <img src="${item.image}" alt="${item.name}" class="cart-item-img">
                            <div class="cart-item-info">
                                <h4 class="cart-item-title">${item.name}</h4>
                                <span class="cart-item-price">R$ ${item.price.toFixed(2)}</span>
                                
                                ${item.obs ? `<p class="cart-item-obs-display">Obs: ${item.obs}</p>` : ''}
                                
                                <div class="quantity-controls">
                                    <button class="quantity-btn decrease-btn" data-index="${index}">
                                        <i data-feather="minus"></i>
                                    </button>
                                    <span class="item-quantity">${item.quantity}</span>
                                    <button class="quantity-btn increase-btn" data-index="${index}">
                                        <i data-feather="plus"></i>
                                    </button>
                                </div>
                            </div>
                            <button class="cart-item-remove-btn remove-btn" data-index="${index}">
                                <i data-feather="x"></i>
                            </button>
                        </div>
                    `;
                    cartItemList.innerHTML += cartItemHTML;
                });

                feather.replace();
                addCartItemEventListeners();
            }
            function addCartItemEventListeners() {
                document.querySelectorAll('.decrease-btn').forEach(btn => {
                    btn.addEventListener('click', handleQuantityChange);
                });
                document.querySelectorAll('.increase-btn').forEach(btn => {
                    btn.addEventListener('click', handleQuantityChange);
                });
                document.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.addEventListener('click', handleRemoveItem);
                });
            }
            function handleQuantityChange(event) {
                const index = event.currentTarget.dataset.index;
                const isIncreasing = event.currentTarget.classList.contains('increase-btn');

                if (isIncreasing) {
                    cart[index].quantity++;
                } else {
                    cart[index].quantity--;
                    if (cart[index].quantity <= 0) {
                        cart.splice(index, 1); 
                    }
                }
                updateCart();
            }
            function handleRemoveItem(event) {
                const index = event.currentTarget.dataset.index;
                cart.splice(index, 1);
                updateCart();
            }


            // --- EVENT LISTENERS ---
            cartButton.addEventListener('click', openCart);
            cartCloseBtn.addEventListener('click', closeCart);
            overlay.addEventListener('click', closeCart);

            addToCartButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    // Lógica para abrir o Modal de Obs
                    const productCard = e.currentTarget.closest('.product-card');
                    const name = productCard.dataset.name;
                    const price = parseFloat(productCard.dataset.price);
                    const image = productCard.querySelector('.product-image').src;
                    
                    currentProductToAdd = { name, price, image };
                    
                    modalProductName.textContent = name;
                    modalObsTextarea.value = '';
                    productModal.style.display = 'flex';
                    modalObsOverlay.style.display = 'block'; 
                });
            });

            finishOrderBtn.addEventListener('click', openPersonalDataModal); 
            
            // Listeners do Modal de Observação 
            modalConfirmBtn.addEventListener('click', confirmAddItemToCart);
            modalCancelBtn.addEventListener('click', closeModalObs); 
            modalObsOverlay.addEventListener('click', closeModalObs);
            
            // Listeners do Modal 1 (Dados Pessoais)
            personalDataConfirmBtn.addEventListener('click', handlePersonalDataSubmit); 
            personalDataCancelBtn.addEventListener('click', closePersonalDataModal); 
            personalDataModalOverlay.addEventListener('click', closePersonalDataModal);

            // Listeners do Modal 2 (Dados de Endereço)
            addressDataConfirmBtn.addEventListener('click', handleAddressDataSubmit); 
            addressDataBackBtn.addEventListener('click', handleBackToPersonalData); 
            addressDataModalOverlay.addEventListener('click', closeAddressDataModal); 
            
            // Listener para buscar CEP (no Modal 2)
            cepModal.addEventListener('blur', (e) => {
                fetchAddressByCep(e.target.value);
            });


            // INICIALIZAÇÃO
            updateCart();
            feather.replace();
        });
    </script>
</body>
</html>
