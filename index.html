<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Express</title>
    
    <link rel="stylesheet" href="style.css">
    
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>

    <header class="header">
        
        <div class="header-sticky-logo-container" id="stickyLogoContainer" style="display: none;">
            <img id="stickyLogo" class="sticky-logo" alt="Logo">
        </div>

        <div class="logo-group">
            <span class="logo-text" id="logoText">Delivery Express</span>
        </div>
        <div class="cart-icon-container" id="cartButton">
            <i data-feather="shopping-cart"></i>
            <span class="cart-count" id="cartCount">0</span>
        </div>
    </header>

    <main class="container">
        <div class="info-header" id="info-header-container">
            </div>
        
        <h1 class="main-title">Cardápio</h1>
        <p class="main-subtitle">Escolha seus produtos favoritos e faça seu pedido</p>

        <div id="product-list-container">
        </div>

    </main>

    <aside class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <i data-feather="shopping-cart"></i>
            <h2 class="cart-title">Carrinho</h2>
            <button class="cart-close-btn" id="cartCloseBtn">
                <i data-feather="x"></i>
            </button>
        </div>

        <div class="cart-items-container" id="cartItemsContainer">
            <div id="cart-item-list">
                <p class="cart-empty-msg">Seu carrinho está vazio.</p>
            </div>
        </div>

        <div class="cart-footer">
            <div class="cart-total">
                <span>Total</span>
                <span id="cartTotal">R$ 0.00</span>
            </div>
            <button class="finish-order-btn" id="finishOrderBtn">
                Finalizar Pedido
            </button>
        </div>
    </aside>

    <div class="overlay" id="overlay"></div>
    
    <div class="modal-overlay" id="modalObsOverlay"></div>
    <div class="product-modal" id="productModal">
        <h3 class="modal-title" id="modalProductName">Nome do Produto</h3>
        <div class="form-group">
            <label for="modalObsTextarea">Tem alguma observação?</label>
            <textarea id="modalObsTextarea" class="modal-textarea" placeholder="Ex: Sem cebola, ponto da carne, etc."></textarea>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" id="modalCancelBtn">Cancelar</button>
            <button class="modal-btn confirm" id="modalConfirmBtn">Adicionar ao Carrinho</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="personalDataModalOverlay"></div>
    <div class="product-modal" id="personalDataModal">
        <h3 class="modal-title">1 de 3: Seus Dados Pessoais</h3>
        
        <form id="personalFormModal">
            <div class="form-group">
                <label for="nomeModal">Nome</label>
                <input type="text" id="nomeModal" name="nome" placeholder="Digite seu nome completo" required>
            </div>
            <div class="form-group">
                <label for="telefoneModal">Telefone</label>
                <input type="tel" id="telefoneModal" name="telefone" placeholder="(99) 99999-8888" maxlength="15" onkeyup="phoneMask(this)" required>
            </div>
            <div class="form-group">
                <label for="cpfModal">CPF (Opcional)</label>
                <input type="text" id="cpfModal" name="cpf" placeholder="000.000.000-00" maxlength="14" onkeyup="cpfMask(this)">
            </div>
            <div class="form-group">
                <label for="pagamentoModal">Forma de Pagamento</label>
                <select id="pagamentoModal" name="pagamento" required>
                    </select>
            </div>
        </form>

        <div class="modal-buttons">
            <button class="modal-btn cancel" id="personalDataCancelBtn">Voltar ao Carrinho</button>
            <button class="modal-btn confirm" id="personalDataConfirmBtn">Continuar</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="deliveryOptionModalOverlay"></div>
    <div class="product-modal" id="deliveryOptionModal">
        <h3 class="modal-title">2 de 3: Opção de Serviço</h3>
        
        <form id="deliveryOptionFormModal">
            <div class="form-group">
                <label for="deliveryOptionSelect">Como deseja receber seu pedido?</label>
                <select id="deliveryOptionSelect" name="deliveryOption" required>
                    </select>
            </div>
        </form>

        <div class="modal-buttons">
            <button class="modal-btn cancel" id="deliveryOptionBackBtn">Voltar</button>
            <button class="modal-btn confirm" id="deliveryOptionConfirmBtn">Continuar</button>
        </div>
    </div>

    <div class="modal-overlay" id="addressDataModalOverlay"></div>
    <div class="product-modal" id="addressDataModal">
        <h3 class="modal-title">3 de 3: Dados de Entrega</h3>
        
        <form id="addressFormModal">
            <div class="form-group">
                <label for="cepModal">CEP</label>
                <input type="text" id="cepModal" name="cep" placeholder="00000-000" maxlength="9" onkeyup="cepMask(this)" required>
            </div>
            
            <div class="address-line-one">
                <div class="form-group rua-input">
                    <label for="ruaModal">Rua</label>
                    <input type="text" id="ruaModal" name="rua" placeholder="Rua / Avenida" required>
                </div>
                <div class="form-group numero-input">
                    <label for="numeroModal">Nº</label>
                    <input type="text" id="numeroModal" name="numero" placeholder="123" required>
                </div>
            </div>
            
            <div class="address-line-two">
                <div class="form-group bairro-input">
                    <label for="bairroModal">Bairro</label>
                    <input type="text" id="bairroModal" name="bairro" placeholder="Bairro" required>
                </div>
                <div class="form-group cidade-input">
                    <label for="cidadeModal">Cidade</label>
                    <input type="text" id="cidadeModal" name="cidade" placeholder="Cidade" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="complementoModal">Complemento (Apto, Bloco, etc)</label>
                <input type="text" id="complementoModal" name="complemento" placeholder="Apto 101, Bloco A">
            </div>
            
            <div class="form-group">
                <label for="freteDisplay">Valor da Entrega</label>
                <input type="text" id="freteDisplay" name="freteDisplay" value="R$ 0,00" readonly style="color: var(--primary-dark); font-weight: 700;">
            </div>
            <div class="form-group">
                <label for="finalTotalDisplay">Total Final do Pedido</label>
                <input type="text" id="finalTotalDisplay" name="finalTotalDisplay" value="R$ 0,00" readonly style="color: #E53935; font-weight: 700; font-size: 1.25rem;">
            </div>
            
        </form>

        <div class="modal-buttons">
            <button class="modal-btn cancel" id="addressDataBackBtn">Voltar</button>
            <button class="modal-btn confirm" id="addressDataConfirmBtn">Enviar Pedido (WhatsApp)</button>
        </div>
    </div>


    <script src="config.js"></script> 
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // As variáveis de configuração são acessadas globalmente (window.)

            // --- SELETORES GLOBAIS ---
            const header = document.querySelector('.header'); 
            const cartButton = document.getElementById('cartButton');
            const cartSidebar = document.getElementById('cartSidebar');
            const overlay = document.getElementById('overlay');
            const productListContainer = document.getElementById('product-list-container');
            const infoHeaderContainer = document.getElementById('info-header-container');
            // NOVO: Seletores para o container da logo e a logo em si no header
            const stickyLogoContainer = document.getElementById('stickyLogoContainer'); 
            const stickyLogo = document.getElementById('stickyLogo'); 
            
            // SELETORES DE DADOS PESSOAIS
            const nomeModal = document.getElementById('nomeModal');
            const telefoneModal = document.getElementById('telefoneModal');
            const cpfModal = document.getElementById('cpfModal'); 
            const pagamentoModal = document.getElementById('pagamentoModal');
            
            // SELETORES DE DADOS DE ENTREGA
            const deliveryOptionSelect = document.getElementById('deliveryOptionSelect');
            const cepModal = document.getElementById('cepModal');
            const ruaModal = document.getElementById('ruaModal');
            const numeroModal = document.getElementById('numeroModal');
            const bairroModal = document.getElementById('bairroModal');
            const cidadeModal = document.getElementById('cidadeModal'); 
            const complementoModal = document.getElementById('complementoModal');
            const freteDisplay = document.getElementById('freteDisplay');
            const finalTotalDisplay = document.getElementById('finalTotalDisplay');

            // SELETORES DE BOTÕES E ESTADO
            const cartCountEl = document.getElementById('cartCount');
            const cartTotalEl = document.getElementById('cartTotal');
            const finishOrderBtn = document.getElementById('finishOrderBtn');
            const addressDataConfirmBtn = document.getElementById('addressDataConfirmBtn');

            let cart = [];
            let currentProductToAdd = null; 
            let customerData = {
                freightCost: 0, 
                finalTotal: 0,
                deliveryOption: 'Entrega'
            }; 

            // --- FUNÇÕES DE MÁSCARA ---
            window.cepMask = function(input) {
                let value = input.value.replace(/\D/g, "");
                value = value.replace(/^(\d{5})(\d)/, "$1-$2");
                input.value = value;
            }
            
            window.phoneMask = function(input) {
                let value = input.value.replace(/\D/g, "");
                value = value.replace(/^(\d{2})(\d)/g, "($1) $2"); 
                value = value.replace(/(\d)(\d{4})$/, "$1-$2"); 
                input.value = value;
            }
            
            window.cpfMask = function(input) {
                let value = input.value.replace(/\D/g, ""); 
                value = value.replace(/(\d{3})(\d)/, "$1.$2");
                value = value.replace(/(\d{3})(\d)/, "$1.$2");
                value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
                input.value = value.substring(0, 14); 
            }

            // --- FUNÇÃO DE VERIFICAÇÃO DE HORÁRIO ---
            function isRestaurantOpen() {
                if (!window.OPERATING_HOURS) return { isOpen: false, hours: "Horário não definido" };

                const now = new Date();
                const dayOfWeek = now.getDay(); // 0 (Domingo) a 6 (Sábado)
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentTimeInMinutes = (currentHour * 60) + currentMinute;

                const todayHours = window.OPERATING_HOURS[dayOfWeek];

                // Verifica se está fechado neste dia
                if (!todayHours || !todayHours.open || !todayHours.close) {
                     return { isOpen: false, hours: "Fechado neste dia" };
                }
                
                // Converte horários de abertura e fechamento para minutos
                const [openH, openM] = todayHours.open.split(':').map(Number);
                const [closeH, closeM] = todayHours.close.split(':').map(Number);

                const openTimeInMinutes = (openH * 60) + openM;
                const closeTimeInMinutes = (closeH * 60) + closeM;
                
                // Formato de exibição
                const displayHours = `${todayHours.open} às ${todayHours.close}`;

                // Lógica de verificação
                const isOpen = currentTimeInMinutes >= openTimeInMinutes && currentTimeInMinutes <= closeTimeInMinutes;

                return { isOpen, hours: displayHours };
            }
            
            // --- FUNÇÃO DE INJEÇÃO DO NOVO HEADER INFORMATIVO ---
            function injectInfoHeader() {
                const { isOpen, hours } = isRestaurantOpen();
                
                const statusText = isOpen ? "Aberto" : "Fechado";
                const statusClass = isOpen ? "open" : "";
                
                // NOVO: Carrega a URL da logo no elemento sticky assim que as configs carregarem
                stickyLogo.src = window.BUSINESS_LOGO_URL || ''; 
                
                const html = `
                    <img src="${window.BUSINESS_LOGO_URL}" alt="${window.BUSINESS_NAME} Logo" class="business-logo">
                    <div class="info-text-wrapper">
                        <h2 class="business-name-display">${window.BUSINESS_NAME}</h2>
                        <div class="status-line">
                            <span class="business-status ${statusClass}">${statusText}</span>
                            <span class="delivery-time-display">
                                <i data-feather="clock"></i> 
                                ${window.DELIVERY_TIME}
                            </span>
                        </div>
                        <p class="operating-hours-display">${hours}</p>
                    </div>
                `;
                
                infoHeaderContainer.innerHTML = html;
                feather.replace(); // Recarrega os ícones Feather
                
                // Desabilita o botão de finalizar pedido se estiver fechado
                finishOrderBtn.disabled = !isOpen || cart.length === 0; 
            }
            
            // --- NOVA FUNÇÃO: LÓGICA DE ROLAGEM E VISIBILIDADE DA LOGO ---
            function handleScrollVisibility() {
                if (!infoHeaderContainer || !stickyLogoContainer) return;

                const infoHeaderBottom = infoHeaderContainer.getBoundingClientRect().bottom;

                if (infoHeaderBottom < 0) {
                    // Quando o info-header saiu da tela
                    stickyLogoContainer.style.display = 'flex'; // Mostra a logo
                } else {
                    // Quando o info-header está visível
                    stickyLogoContainer.style.display = 'none'; // Esconde a logo
                }
            }

            // --- FUNÇÃO PARA CALCULAR O FRETE POR BAIRRO E CIDADE ---
            function calculateFreightByNeighborhood(neighborhood, city) {
                if (!neighborhood || !city || !window.FREIGHT_TABLE_BY_NEIGHBORHOOD) return 0;
                
                // Normaliza Bairro e Cidade (minúsculas, sem acentos, sem espaços extras)
                let cleanNeighborhood = neighborhood
                    .toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .trim();
                    
                let cleanCity = city
                    .toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .trim();
                    
                const key = `${cleanCity}-${cleanNeighborhood}`; // CHAVE: CIDADE-BAIRRO
                
                if (window.FREIGHT_TABLE_BY_NEIGHBORHOOD[key] !== undefined) {
                    return window.FREIGHT_TABLE_BY_NEIGHBORHOOD[key];
                }
                
                return 0; // Frete 0 se não encontrar
            }
            
            // --- FUNÇÃO DE BUSCA DE ENDEREÇO (VIACEP) ---
            async function fetchAddressByCep(cep) {
                const cleanCep = cep.replace(/\D/g, '');
                if (cleanCep.length !== 8) return; 

                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);
                    const data = await response.json();

                    if (!data.erro) {
                        ruaModal.value = data.logradouro || '';
                        bairroModal.value = data.bairro || '';
                        cidadeModal.value = data.localidade || ''; 
                        numeroModal.focus(); 
                    } else {
                        ruaModal.value = '';
                        bairroModal.value = '';
                        cidadeModal.value = '';
                    }
                } catch (error) {
                    console.error("Erro ao buscar CEP:", error);
                }
            }
            
            // --- FUNÇÕES DE CÁLCULO E ATUALIZAÇÃO ---
            
            function updateFinalTotalDisplay() {
                const cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                customerData.freightCost = 0;
                
                if (customerData.deliveryOption === 'Entrega') {
                    const currentNeighborhood = bairroModal.value;
                    const currentCity = cidadeModal.value;
                    
                    customerData.freightCost = calculateFreightByNeighborhood(currentNeighborhood, currentCity);
                }
                
                customerData.finalTotal = cartTotal + customerData.freightCost;
                
                // Atualiza a exibição no modal
                freteDisplay.value = `R$ ${customerData.freightCost.toFixed(2).replace('.', ',')}`;
                finalTotalDisplay.value = `R$ ${customerData.finalTotal.toFixed(2).replace('.', ',')}`;

                // --- Lógica de Validação da Área de Entrega ---
                const bairroValue = bairroModal.value.trim();
                const cidadeValue = cidadeModal.value.trim();

                if (customerData.deliveryOption === 'Entrega' && cartTotal > 0) {
                    if (bairroValue.length === 0 || cidadeValue.length === 0) {
                        addressDataConfirmBtn.disabled = true;
                        finalTotalDisplay.style.color = 'red';
                        finalTotalDisplay.value = 'PREENCHA O ENDEREÇO';
                    } 
                    else if (customerData.freightCost === 0) {
                        addressDataConfirmBtn.disabled = true;
                        finalTotalDisplay.style.color = 'red';
                        finalTotalDisplay.value = 'BAIRRO/CIDADE FORA DA ÁREA DE ENTREGA';
                    } 
                    else {
                        addressDataConfirmBtn.disabled = false;
                        finalTotalDisplay.style.color = '#E53935'; 
                    }
                } else {
                    addressDataConfirmBtn.disabled = false;
                    finalTotalDisplay.style.color = '#E53935';
                }
            }
            
            function openAddressDataModal() {
                const addressDataModal = document.getElementById('addressDataModal');
                const addressDataModalOverlay = document.getElementById('addressDataModalOverlay');
                const deliveryOptionModal = document.getElementById('deliveryOptionModal');
                const deliveryOptionModalOverlay = document.getElementById('deliveryOptionModalOverlay');
                
                deliveryOptionModal.style.display = 'none';
                deliveryOptionModalOverlay.style.display = 'none';
                
                addressDataModal.style.display = 'flex';
                addressDataModalOverlay.style.display = 'block';
                
                updateFinalTotalDisplay();
            }

            function handlePersonalDataSubmit() {
                if (!document.getElementById('personalFormModal').checkValidity()) {
                    document.getElementById('personalFormModal').reportValidity();
                    return;
                }

                const formData = new FormData(document.getElementById('personalFormModal'));
                customerData.nome = formData.get('nome');
                customerData.telefone = formData.get('telefone');
                customerData.cpf = formData.get('cpf');
                customerData.pagamento = formData.get('pagamento');
                
                document.getElementById('personalDataModal').style.display = 'none';
                document.getElementById('personalDataModalOverlay').style.display = 'none';
                document.getElementById('deliveryOptionModal').style.display = 'flex';
                document.getElementById('deliveryOptionModalOverlay').style.display = 'block';
            }

            function handleDeliveryOptionSubmit() {
                 if (!document.getElementById('deliveryOptionFormModal').checkValidity()) {
                    document.getElementById('deliveryOptionFormModal').reportValidity();
                    return;
                }
                
                const option = deliveryOptionSelect.value;
                customerData.deliveryOption = option;

                if (option === 'Entrega') {
                    customerData.freightCost = 0;
                    openAddressDataModal();
                } else if (option === 'Retirada') {
                    customerData.freightCost = 0;
                    customerData.finalTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    
                    document.getElementById('deliveryOptionModal').style.display = 'none';
                    document.getElementById('deliveryOptionModalOverlay').style.display = 'none';
                    sendOrderToWhatsapp();
                }
            }

            function handleAddressDataSubmit() {
                if (!document.getElementById('addressFormModal').checkValidity() || addressDataConfirmBtn.disabled) {
                    document.getElementById('addressFormModal').reportValidity();
                    return;
                }
                
                updateFinalTotalDisplay(); 

                const formData = new FormData(document.getElementById('addressFormModal'));
                customerData.cep = formData.get('cep');
                customerData.rua = formData.get('rua');
                customerData.numero = formData.get('numero');
                customerData.bairro = formData.get('bairro');
                customerData.cidade = formData.get('cidade');
                customerData.complemento = formData.get('complemento');
                
                sendOrderToWhatsapp();
            }

            // --- FUNÇÃO PARA ENVIAR O PEDIDO VIA WHATSAPP (MENSAGEM FINAL) ---
            function sendOrderToWhatsapp() {
                updateFinalTotalDisplay();
                
                let message = "Olá, gostaria de fazer um novo pedido:\n\n";
                message += `*MODALIDADE:* ${customerData.deliveryOption}\n`;
                message += "-----------------\n\n";
                
                message += "*== ITENS DO PEDIDO ==*\n";
                
                cart.forEach(item => {
                    message += `*${item.quantity}x* - ${item.name}\n`;
                    message += `(Preço un.: R$ ${item.price.toFixed(2).replace('.', ',')})\n`;
                    if (item.obs) {
                        message += `  *Obs:* ${item.obs}\n`;
                    }
                    message += "-----------------\n";
                });

                const subtotal = customerData.finalTotal - customerData.freightCost;
                message += `\n*SUBTOTAL DO PEDIDO: R$ ${subtotal.toFixed(2).replace('.', ',')}*\n`;
                
                if (customerData.deliveryOption === 'Entrega' && customerData.freightCost > 0) {
                     message += `*TAXA DE ENTREGA: R$ ${customerData.freightCost.toFixed(2).replace('.', ',')}*\n`;
                }

                message += `*TOTAL FINAL: R$ ${customerData.finalTotal.toFixed(2).replace('.', ',')}*\n`;
                message += `*FORMA DE PAGAMENTO:* ${customerData.pagamento}\n\n`; 

                message += "*== DADOS DO CLIENTE ==*\n";
                message += `*Nome:* ${customerData.nome}\n`;
                message += `*Telefone:* ${customerData.telefone}\n`;
                if (customerData.cpf) { 
                    message += `*CPF:* ${customerData.cpf}\n`;
                }
                
                if (customerData.deliveryOption === 'Entrega') {
                    message += "\n*== DADOS DE ENTREGA ==*\n";
                    const enderecoCompleto = `${customerData.rua}, ${customerData.numero} - ${customerData.bairro}, ${customerData.cidade}`;
                    message += `*Endereço:* ${enderecoCompleto}\n`;
                    if (customerData.complemento) {
                        message += `*Complemento:* ${customerData.complemento}\n`;
                    }
                    message += `*CEP:* ${customerData.cep}\n`;
                } else {
                    message += "\n*O pedido será retirado na loja.*\n";
                }

                const encodedMessage = encodeURIComponent(message);
                const whatsappURL = `https://api.whatsapp.com/send?phone=${window.WHATSAPP_NUMBER}&text=${encodedMessage}`;
                
                window.open(whatsappURL, '_blank');
                
                document.getElementById('personalDataModal').style.display = 'none';
                document.getElementById('personalDataModalOverlay').style.display = 'none';
                document.getElementById('addressDataModal').style.display = 'none';
                document.getElementById('addressDataModalOverlay').style.display = 'none';
                document.getElementById('deliveryOptionModal').style.display = 'none';
                document.getElementById('deliveryOptionModalOverlay').style.display = 'none';
            }
            
            // --- FUNÇÕES DE INJEÇÃO DINÂMICA (CONFIG.JS) ---

            function injectProductList() {
                let html = '';
                if (!window.PRODUCTS) return;
                
                for (const categoryName in window.PRODUCTS) {
                    html += `<section class="category">`;
                    html += `<h2 class="category-title">${categoryName}</h2>`;
                    
                    window.PRODUCTS[categoryName].forEach(product => {
                        
                        const isPromotion = product.oldPrice && product.oldPrice > product.price;
                        let priceHtml = '';

                        if (isPromotion) {
                            // Calcula o percentual de desconto
                            const discount = Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100);
                            
                            // HTML com preço de promoção, preço riscado e badge
                            priceHtml = `
                                <div class="price-promotion-wrapper">
                                    <span class="product-price promotion-price">R$ ${product.price.toFixed(2).replace('.', ',')}</span>
                                    <div class="old-price-line">
                                        <span class="product-old-price">R$ ${product.oldPrice.toFixed(2).replace('.', ',')}</span>
                                        <span class="discount-badge">-${discount}%</span>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Preço normal (mantém a classe .product-price para estilização de cor)
                            priceHtml = `<span class="product-price">R$ ${product.price.toFixed(2).replace('.', ',')}</span>`;
                        }
                        
                        html += `
                            <article class="product-card" data-name="${product.name}" data-price="${product.price}">
                                
                                <img src="${product.image}" alt="${product.name}" class="product-image">
                                
                                <div class="product-details-wrapper">
                                    <div class="product-info">
                                        <h3 class="product-title">${product.name}</h3>
                                        <p class="product-description">${product.description}</p>
                                    </div>
                                    
                                    <div class="product-footer">
                                        ${priceHtml} 
                                        <button class="add-to-cart-btn">
                                            <i data-feather="plus"></i> Adicionar
                                        </button>
                                    </div>
                                </div>
                            </article>
                        `;
                    });
                    html += `</section>`;
                }
                productListContainer.innerHTML = html;
            }

            function injectOptions() {
                // Injeta Nome do Negócio no Header fixo
                document.getElementById('logoText').textContent = window.BUSINESS_NAME || "Delivery Express";

                // Injeta Formas de Pagamento
                let paymentHtml = '<option value="" disabled selected>Selecione a forma de pagamento</option>';
                if (window.PAYMENT_OPTIONS) {
                    window.PAYMENT_OPTIONS.forEach(option => {
                        paymentHtml += `<option value="${option}">${option}</option>`;
                    });
                }
                pagamentoModal.innerHTML = paymentHtml;

                // Injeta Opções de Entrega
                let deliveryHtml = '<option value="" disabled selected>Escolha uma opção</option>';
                if (window.DELIVERY_OPTIONS) {
                    window.DELIVERY_OPTIONS.forEach(option => {
                        deliveryHtml += `<option value="${option}">${option}</option>`;
                    });
                }
                deliveryOptionSelect.innerHTML = deliveryHtml;
            }

            // --- LÓGICA DO CARRINHO (Mantida) ---
            
            function updateCart() {
                renderCartItems();
                updateCartSummary();
                injectInfoHeader(); // ATUALIZA O STATUS DE HABILITAÇÃO DO BOTÃO
            }
            
            function updateCartSummary() {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                cartCountEl.textContent = totalItems;
                cartTotalEl.textContent = `R$ ${totalPrice.toFixed(2).replace('.', ',')}`;
                
                const { isOpen } = isRestaurantOpen();
                finishOrderBtn.disabled = cart.length === 0 || !isOpen; // ATUALIZA AQUI TBM
            }

            function renderCartItems() {
                const cartItemList = document.getElementById('cart-item-list');
                const cartEmptyMsg = '<p class="cart-empty-msg">Seu carrinho está vazio.</p>';
                if (cart.length === 0) {
                    cartItemList.innerHTML = cartEmptyMsg;
                    return;
                }
                
                cartItemList.innerHTML = ''; 

                cart.forEach((item, index) => {
                    const cartItemHTML = `
                        <div class="cart-item">
                            <img src="${item.image}" alt="${item.name}" class="cart-item-img">
                            <div class="cart-item-info">
                                <h4 class="cart-item-title">${item.name}</h4>
                                <span class="cart-item-price">R$ ${item.price.toFixed(2).replace('.', ',')}</span>
                                ${item.obs ? `<p class="cart-item-obs-display">Obs: ${item.obs}</p>` : ''}
                                <div class="quantity-controls">
                                    <button class="quantity-btn decrease-btn" data-index="${index}">
                                        <i data-feather="minus"></i>
                                    </button>
                                    <span class="item-quantity">${item.quantity}</span>
                                    <button class="quantity-btn increase-btn" data-index="${index}">
                                        <i data-feather="plus"></i>
                                    </button>
                                </div>
                            </div>
                            <button class="cart-item-remove-btn remove-btn" data-index="${index}">
                                <i data-feather="x"></i>
                            </button>
                        </div>
                    `;
                    cartItemList.innerHTML += cartItemHTML;
                });

                feather.replace();
                addCartItemEventListeners();
            }
            function addCartItemEventListeners() {
                document.querySelectorAll('.decrease-btn').forEach(btn => {
                    btn.addEventListener('click', handleQuantityChange);
                });
                document.querySelectorAll('.increase-btn').forEach(btn => {
                    btn.addEventListener('click', handleQuantityChange);
                });
                document.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.addEventListener('click', handleRemoveItem);
                });
            }
            function handleQuantityChange(event) {
                const index = event.currentTarget.dataset.index;
                const isIncreasing = event.currentTarget.classList.contains('increase-btn');

                if (isIncreasing) {
                    cart[index].quantity++;
                } else {
                    cart[index].quantity--;
                    if (cart[index].quantity <= 0) {
                        cart.splice(index, 1); 
                    }
                }
                updateCart();
            }
            function handleRemoveItem(event) {
                const index = event.currentTarget.dataset.index;
                cart.splice(index, 1);
                updateCart();
            }
            function confirmAddItemToCart() {
                const productModal = document.getElementById('productModal');
                const modalObsOverlay = document.getElementById('modalObsOverlay'); 
                const modalObsTextarea = document.getElementById('modalObsTextarea');
                
                if (!currentProductToAdd) return;

                const { name, price, image } = currentProductToAdd;
                const obs = modalObsTextarea.value.trim();

                const existingItem = cart.find(item => item.name === name && item.obs === obs);

                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cart.push({ name, price, image, quantity: 1, obs: obs });
                }

                updateCart();
                productModal.style.display = 'none';
                modalObsOverlay.style.display = 'none';
                currentProductToAdd = null;
            }


            // --- EVENT LISTENERS ---
            document.getElementById('cartButton').addEventListener('click', () => { cartSidebar.classList.add('open'); overlay.classList.add('open'); });
            document.getElementById('cartCloseBtn').addEventListener('click', () => { cartSidebar.classList.remove('open'); overlay.classList.remove('open'); });
            overlay.addEventListener('click', () => { cartSidebar.classList.remove('open'); overlay.classList.remove('open'); });

            productListContainer.addEventListener('click', (e) => {
                if (e.target.closest('.add-to-cart-btn')) {
                    const productCard = e.target.closest('.product-card');
                    const name = productCard.dataset.name;
                    const price = parseFloat(productCard.dataset.price);
                    const image = productCard.querySelector('.product-image').src; 
                    
                    currentProductToAdd = { name, price, image };
                    
                    document.getElementById('modalProductName').textContent = name;
                    document.getElementById('modalObsTextarea').value = '';
                    document.getElementById('productModal').style.display = 'flex';
                    document.getElementById('modalObsOverlay').style.display = 'block'; 
                }
            });

            document.getElementById('finishOrderBtn').addEventListener('click', () => {
                if (finishOrderBtn.disabled) return; 

                if (cart.length === 0) { alert("Seu carrinho está vazio."); return; }
                document.getElementById('cartSidebar').classList.remove('open');
                document.getElementById('overlay').classList.remove('open');
                document.getElementById('personalDataModal').style.display = 'flex';
                document.getElementById('personalDataModalOverlay').style.display = 'block';
            }); 
            
            document.getElementById('modalConfirmBtn').addEventListener('click', confirmAddItemToCart);
            document.getElementById('modalCancelBtn').addEventListener('click', () => { document.getElementById('productModal').style.display = 'none'; document.getElementById('modalObsOverlay').style.display = 'none'; currentProductToAdd = null; }); 
            document.getElementById('modalObsOverlay').addEventListener('click', () => { document.getElementById('productModal').style.display = 'none'; document.getElementById('modalObsOverlay').style.display = 'none'; currentProductToAdd = null; });
            
            if (cpfModal) {
                cpfModal.addEventListener('keyup', (e) => window.cpfMask(e.target));
            }
            document.getElementById('personalDataConfirmBtn').addEventListener('click', handlePersonalDataSubmit); 
            document.getElementById('personalDataCancelBtn').addEventListener('click', () => { document.getElementById('personalDataModal').style.display = 'none'; document.getElementById('personalDataModalOverlay').style.display = 'none'; document.getElementById('cartSidebar').classList.add('open'); document.getElementById('overlay').classList.add('open'); }); 
            
            document.getElementById('deliveryOptionConfirmBtn').addEventListener('click', handleDeliveryOptionSubmit); 
            document.getElementById('deliveryOptionBackBtn').addEventListener('click', () => { document.getElementById('deliveryOptionModal').style.display = 'none'; document.getElementById('deliveryOptionModalOverlay').style.display = 'none'; document.getElementById('personalDataModal').style.display = 'flex'; document.getElementById('personalDataModalOverlay').style.display = 'block'; });
            
            document.getElementById('addressDataConfirmBtn').addEventListener('click', handleAddressDataSubmit); 
            document.getElementById('addressDataBackBtn').addEventListener('click', () => { document.getElementById('addressDataModal').style.display = 'none'; document.getElementById('addressDataModalOverlay').style.display = 'none'; document.getElementById('deliveryOptionModal').style.display = 'flex'; document.getElementById('deliveryOptionModalOverlay').style.display = 'block'; }); 
            
            cepModal.addEventListener('blur', (e) => {
                fetchAddressByCep(e.target.value).then(() => {
                    updateFinalTotalDisplay();
                });
            });
            
            bairroModal.addEventListener('keyup', updateFinalTotalDisplay);
            bairroModal.addEventListener('blur', updateFinalTotalDisplay);
            cidadeModal.addEventListener('keyup', updateFinalTotalDisplay);
            cidadeModal.addEventListener('blur', updateFinalTotalDisplay);
            
            // INICIALIZAÇÃO FINAL
            injectOptions();
            injectProductList();
            injectInfoHeader(); 
            updateCart();
            feather.replace();
            
            // NOVO: ADICIONA EVENTO DE SCROLL
            window.addEventListener('scroll', handleScrollVisibility);
            handleScrollVisibility(); // Chama uma vez para inicializar o estado correto
        });
    </script>
</body>
</html>
